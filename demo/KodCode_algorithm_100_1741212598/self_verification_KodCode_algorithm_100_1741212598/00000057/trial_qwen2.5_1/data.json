{
  "metadata": {
    "prompt_id": "00000057",
    "row_id": 57,
    "seed_ids": [
      844
    ],
    "mode": "algorithm"
  },
  "instruction": "You are tasked with optimizing an existing Gaussian filter implementation to handle large images and large kernel sizes more efficiently. The provided code uses a straightforward approach to apply the Gaussian filter, which can be slow for large images. Your goal is to refactor the code to improve its performance without changing its functionality.\n\n**Requirements**:\n1. Modify the `gaussian_filter` function to handle images and kernels of arbitrary size.\n2. Ensure that the function correctly handles the edges of the image, producing valid results even when the kernel extends beyond the image boundaries.\n3. Optimize the code to reduce the number of operations and improve performance.\n4. Write a function `test_gaussian_filter` that reads an image, applies the Gaussian filter, and displays the original and filtered images side by side for verification.\n\n**Constraints**:\n* The input image is a grayscale image represented as a 2D NumPy array.\n* The kernel size is an odd integer, and the standard deviation is a positive float.\n* The function should handle images of any size and kernel sizes up to 21x21.\n\n**Performance**:\n* Aim to achieve a significant performance improvement over the provided code, especially for large images and larger kernel sizes.\n\n**Example**:\nGiven an input image and a kernel size of 5x5, the function should return a filtered image.\n\n```python\nimport numpy as np\nimport cv2\nimport matplotlib.pyplot as plt\n\ndef test_gaussian_filter(image_path, k_size, sigma):\n    # Read the image as grayscale\n    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)\n    \n    # Apply the Gaussian filter\n    filtered_image = gaussian_filter(img, k_size, sigma)\n    \n    # Display the original and filtered images\n    plt.subplot(1, 2, 1)\n    plt.imshow(img, cmap='gray')\n    plt.title('Original Image')\n    plt.axis('off')\n    \n    plt.subplot(1, 2, 2)\n    plt.imshow(filtered_image, cmap='gray')\n    plt.title('Filtered Image')\n    plt.axis('off')\n    \n    plt.show()\n\n# Example usage\ntest_gaussian_filter('path_to_image.jpg', 5, 1.0)\n```\n\n**Note**: The `gaussian_filter` function should be refactored to meet the above requirements and should not rely on the provided code snippet.",
  "solution_code": "import numpy as np\nimport cv2\n\ndef gaussian_filter(image, k_size, sigma):\n    \"\"\"\n    Apply a Gaussian filter to the input grayscale image.\n    \"\"\"\n    kernel = cv2.getGaussianKernel(k_size, sigma)\n    kernel_2D = np.outer(kernel, kernel.transpose())\n    kernel_2D /= kernel_2D.sum()\n    \n    filtered_image = np.zeros_like(image)\n    pad_size = k_size // 2\n    padded_image = np.pad(image, pad_size, mode='edge')\n    \n    for y in range(image.shape[0]):\n        for x in range(image.shape[1]):\n            filtered_image[y, x] = (padded_image[y:y+k_size, x:x+k_size] * kernel_2D).sum()\n    \n    return filtered_image",
  "test_code": "import numpy as np\nimport cv2\nfrom solution import gaussian_filter\n\ndef test_gaussian_filter():\n    # Generate a simple test image\n    test_image = np.array([\n        [0, 0, 0, 0, 0],\n        [0, 1, 2, 3, 0],\n        [0, 4, 5, 6, 0],\n        [0, 7, 8, 9, 0],\n        [0, 0, 0, 0, 0]\n    ], dtype=np.float32)\n    \n    # Apply the Gaussian filter\n    filtered_image = gaussian_filter(test_image, 3, 1.0)\n    \n    # Expected result after applying Gaussian filter (approximate values)\n    expected_filtered_image = np.array([\n        [2.44, 3.44, 4.44, 3.44, 2.44],\n        [4.16, 6.5, 9.0, 6.5, 4.16],\n        [6.44, 9.0, 11.44, 9.0, 6.44],\n        [4.16, 6.5, 9.0, 6.5, 4.16],\n        [2.44, 3.44, 4.44, 3.44, 2.44]\n    ], dtype=np.float32)\n    \n    # Calculate the difference between the expected and actual results\n    diff = np.linalg.norm(filtered_image - expected_filtered_image)\n    \n    # Check if the difference is within an acceptable tolerance\n    assert diff < 0.1, f\"Expected filtered image to be close to expected_filtered_image, but got a difference of {diff}\"\n\n# Run the test\ntest_gaussian_filter()",
  "file_source": "KodCode_questions2sv_algorithm_100_1741212598_sanitized_prepared_results1.jsonl"
}